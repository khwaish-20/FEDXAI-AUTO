<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FEDXAI-AUTO Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 8px currentColor;
        }

        canvas {
            max-height: 150px;
        }
    </style>
</head>

<body class="p-6">
    <!-- Header -->
    <div class="max-w-6xl mx-auto mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-cyan-300 bg-clip-text text-transparent">
                <i class="fa-solid fa-car-side mr-2 text-white"></i> FEDXAI-AUTO
            </h1>
            <p class="text-slate-400 text-sm">Federated XAI Predictive Maintenance</p>
        </div>
        <div class="flex items-center gap-4">
            <div id="connection-status" class="flex items-center gap-2 px-4 py-2 rounded-full glass text-slate-400">
                <span class="status-dot bg-slate-500" id="status-dot"></span>
                <span id="status-text">Disconnected</span>
            </div>
            <button onclick="connectBLE()"
                class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-medium transition-all shadow-lg shadow-blue-500/20">
                <i class="fa-brands fa-bluetooth-b mr-2"></i> Connect Dongle
            </button>
        </div>
    </div>

    <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Metrics -->
        <div class="md:col-span-2 space-y-6">
            <div class="grid grid-cols-3 gap-4">
                <div class="glass p-4 rounded-xl text-center">
                    <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Engine RPM</div>
                    <div class="text-3xl font-mono font-bold text-cyan-400" id="val-rpm">0</div>
                    <div class="text-xs text-slate-500">rpm</div>
                </div>
                <div class="glass p-4 rounded-xl text-center">
                    <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Coolant Temp</div>
                    <div class="text-3xl font-mono font-bold text-orange-400" id="val-temp">0°</div>
                    <div class="text-xs text-slate-500">Celsius</div>
                </div>
                <div class="glass p-4 rounded-xl text-center">
                    <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Fuel Pressure</div>
                    <div class="text-3xl font-mono font-bold text-purple-400" id="val-fp">0.0</div>
                    <div class="text-xs text-slate-500">Bar</div>
                </div>
            </div>
            <div class="glass p-4 rounded-xl">
                <h3 class="text-sm font-semibold text-slate-300 mb-4">Live Sensor Telemetry</h3>
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <!-- AI Panel -->
        <div class="space-y-6">
            <div class="glass p-6 rounded-xl text-center relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-br from-green-500/10 to-transparent" id="health-bg"></div>
                <h3 class="text-sm font-semibold text-slate-300 mb-2 relative z-10">Vehicle Health</h3>
                <div class="text-5xl font-bold text-green-400 mb-2 relative z-10" id="health-score">100%</div>
                <div class="text-sm text-green-200 font-medium px-3 py-1 bg-green-900/40 rounded-full inline-block relative z-10"
                    id="health-status">
                    <i class="fa-solid fa-check-circle mr-1"></i> HEALTHY
                </div>
            </div>

            <div class="glass p-4 rounded-xl">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-xs text-slate-400 uppercase">Failure Probability</span>
                    <span class="text-xl font-bold text-slate-200" id="fail-prob">0.0%</span>
                </div>
                <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                    <div class="bg-red-500 h-full w-0 transition-all duration-500" id="fail-bar"></div>
                </div>
            </div>

            <div class="glass p-4 rounded-xl border-l-4 border-slate-600" id="alert-box">
                <h3 class="text-sm font-semibold text-slate-300 mb-2">
                    <i class="fa-solid fa-robot mr-2 text-blue-400"></i> AI Diagnosis
                </h3>
                <p class="text-sm text-slate-400" id="xai-msg">Waiting for data...</p>
            </div>

            <div class="glass p-3 rounded-xl h-32 overflow-y-auto font-mono text-xs text-slate-500" id="console-log">
                <div>> System ready. Click 'Connect'.</div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG MATCHING MAIN.CPP ---
        const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
        const CHAR_PROB_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a9';  // Float
        const CHAR_ALERT_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26aa'; // String
        const CHAR_SENSORS_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26ab'; // JSON

        const ctx = document.getElementById('mainChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(20).fill(''),
                datasets: [
                    { label: 'RPM', data: Array(20).fill(0), borderColor: '#22d3ee', tension: 0.4 },
                    { label: 'Temp', data: Array(20).fill(0), borderColor: '#fb923c', tension: 0.4 },
                    { label: 'Pressure', data: Array(20).fill(0), borderColor: '#c084fc', tension: 0.4 }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { grid: { color: '#334155' } } },
                animation: false
            }
        });

        let device, server, probChar, alertChar, sensorChar;

        function log(msg) {
            const el = document.getElementById('console-log');
            el.innerHTML += `<div><span class="text-slate-600">[${new Date().toLocaleTimeString()}]</span> ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        async function connectBLE() {
            try {
                log('Scanning for FedXAI-Dongle...');
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'FedXAI-Dongle' }],
                    optionalServices: [SERVICE_UUID]
                });

                log(`Connecting to ${device.name}...`);
                document.getElementById('status-text').innerText = 'Connecting...';

                server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);

                log('Getting characteristics...');
                probChar = await service.getCharacteristic(CHAR_PROB_UUID);
                alertChar = await service.getCharacteristic(CHAR_ALERT_UUID);
                sensorChar = await service.getCharacteristic(CHAR_SENSORS_UUID);

                await probChar.startNotifications();
                probChar.addEventListener('characteristicvaluechanged', handleProb);

                await alertChar.startNotifications();
                alertChar.addEventListener('characteristicvaluechanged', handleAlert);

                await sensorChar.startNotifications(); // Ensure firmware supports notify on this char
                sensorChar.addEventListener('characteristicvaluechanged', handleSensors);

                // If firmware doesn't notify specific chars, we might need a read loop
                // But Phase 4.2 firmware uses notify() for all.

                document.getElementById('status-text').innerText = 'Connected';
                document.getElementById('status-dot').className = 'status-dot bg-green-500';
                log('Connected! Listening for streams...');

            } catch (error) {
                log(`Error: ${error}`);
                document.getElementById('status-text').innerText = 'Error';
                document.getElementById('status-dot').className = 'status-dot bg-red-500';
            }
        }

        function handleProb(event) {
            const val = event.target.value.getFloat32(0, true);
            const prob = (val * 100).toFixed(1);

            document.getElementById('fail-prob').innerText = `${prob}%`;
            document.getElementById('fail-bar').style.width = `${prob}%`;
            document.getElementById('health-score').innerText = `${(100 - prob).toFixed(0)}%`;

            // UI State Update
            const isFail = val > 0.5;
            const healthStatus = document.getElementById('health-status');
            const bg = document.getElementById('health-bg');

            if (isFail) {
                healthStatus.className = "text-sm text-red-200 font-medium px-3 py-1 bg-red-900/60 rounded-full inline-block relative z-10";
                healthStatus.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-1"></i> FAILURE IMMINENT`;
                bg.className = "absolute inset-0 bg-red-500/10 animate-pulse";
                document.getElementById('alert-box').className = "glass p-4 rounded-xl border-l-4 border-red-500 bg-red-900/20";
            } else {
                healthStatus.className = "text-sm text-green-200 font-medium px-3 py-1 bg-green-900/40 rounded-full inline-block relative z-10";
                healthStatus.innerHTML = `<i class="fa-solid fa-check-circle mr-1"></i> HEALTHY`;
                bg.className = "absolute inset-0 bg-green-500/10";
                document.getElementById('alert-box').className = "glass p-4 rounded-xl border-l-4 border-green-500";
            }
        }

        function handleAlert(event) {
            const dec = new TextDecoder();
            const msg = dec.decode(event.target.value);
            document.getElementById('xai-msg').innerText = msg;
        }

        function handleSensors(event) {
            const dec = new TextDecoder();
            const jsonStr = dec.decode(event.target.value);
            try {
                const data = JSON.parse(jsonStr);

                // Update Gauges
                document.getElementById('val-rpm').innerText = data.rpm;
                document.getElementById('val-temp').innerText = data.ct + '°';
                document.getElementById('val-fp').innerText = data.fp;

                // Update Chart
                chart.data.datasets[0].data.push(data.rpm / 80); // Scaled RPM
                chart.data.datasets[1].data.push(data.ct);       // Temp
                chart.data.datasets[2].data.push(data.fp * 10);  // Pressure (Bar -> scaled for vis)

                chart.data.datasets.forEach(ds => ds.data.shift());
                chart.update('none');

            } catch (e) {
                console.error("JSON Parse Error", e);
            }
        }
    </script>
</body>

</html>
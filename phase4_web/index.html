<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FEDXAI-AUTO Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 8px currentColor;
        }

        .text-neon-green {
            color: #4ade80;
            text-shadow: 0 0 5px rgba(74, 222, 128, 0.5);
        }

        .text-neon-red {
            color: #f87171;
            text-shadow: 0 0 5px rgba(248, 113, 113, 0.5);
        }

        canvas {
            max-height: 150px;
        }
    </style>
</head>

<body class="p-6">

    <!-- Header -->
    <div class="max-w-6xl mx-auto mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-cyan-300 bg-clip-text text-transparent">
                <i class="fa-solid fa-car-side mr-2 text-white"></i> FEDXAI-AUTO
            </h1>
            <p class="text-slate-400 text-sm">Federated XAI Predictive Maintenance</p>
        </div>
        <div class="flex items-center gap-4">
            <div id="connection-status" class="flex items-center gap-2 px-4 py-2 rounded-full glass text-slate-400">
                <span class="status-dot bg-slate-500" id="status-dot"></span>
                <span id="status-text">Disconnected</span>
            </div>
            <button onclick="connectBLE()"
                class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-medium transition-all shadow-lg shadow-blue-500/20">
                <i class="fa-brands fa-bluetooth-b mr-2"></i> Connect Dongle
            </button>
        </div>
    </div>

    <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">

        <!-- Live Metrics Panel -->
        <div class="md:col-span-2 space-y-6">
            <!-- Top stats -->
            <div class="grid grid-cols-3 gap-4">
                <div class="glass p-4 rounded-xl text-center">
                    <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Engine RPM</div>
                    <div class="text-3xl font-mono font-bold text-cyan-400" id="val-rpm">0</div>
                    <div class="text-xs text-slate-500">rpm</div>
                </div>
                <div class="glass p-4 rounded-xl text-center">
                    <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Coolant Temp</div>
                    <div class="text-3xl font-mono font-bold text-orange-400" id="val-temp">0°</div>
                    <div class="text-xs text-slate-500">Celsius</div>
                </div>
                <div class="glass p-4 rounded-xl text-center">
                    <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Engine Load</div>
                    <div class="text-3xl font-mono font-bold text-purple-400" id="val-load">0%</div>
                    <div class="text-xs text-slate-500">Percentage</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="glass p-4 rounded-xl">
                <h3 class="text-sm font-semibold text-slate-300 mb-4">Live Sensor Telemetry</h3>
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <!-- AI Diagnostics Panel -->
        <div class="space-y-6">
            <!-- Health Status -->
            <div class="glass p-6 rounded-xl text-center relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-br from-green-500/10 to-transparent" id="health-bg"></div>
                <h3 class="text-sm font-semibold text-slate-300 mb-2 relative z-10">Vehicle Health</h3>
                <div class="text-5xl font-bold text-green-400 mb-2 relative z-10" id="health-score">100%</div>
                <div class="text-sm text-green-200 font-medium px-3 py-1 bg-green-900/40 rounded-full inline-block relative z-10"
                    id="health-status">
                    <i class="fa-solid fa-check-circle mr-1"></i> HEALTHY
                </div>
            </div>

            <!-- Failure Probability -->
            <div class="glass p-4 rounded-xl">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-xs text-slate-400 uppercase">Failure Probability</span>
                    <span class="text-xl font-bold text-slate-200" id="fail-prob">0.0%</span>
                </div>
                <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                    <div class="bg-red-500 h-full w-0 transition-all duration-500" id="fail-bar"></div>
                </div>
            </div>

            <!-- XAI Alert Box -->
            <div class="glass p-4 rounded-xl border-l-4 border-slate-600" id="alert-box">
                <h3 class="text-sm font-semibold text-slate-300 mb-2">
                    <i class="fa-solid fa-robot mr-2 text-blue-400"></i> AI Diagnosis
                </h3>
                <p class="text-sm text-slate-400" id="xai-msg">Waiting for data...</p>
            </div>

            <!-- Console Log -->
            <div class="glass p-3 rounded-xl h-32 overflow-y-auto font-mono text-xs text-slate-500" id="console-log">
                <div>> System initialized.</div>
                <div>> Waiting for BLE connection...</div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const SERVICE_UUID = '12345678-1234-1234-1234-1234567890ab'; // Match ESP32
        const FAIL_CHAR_UUID = '87654321-4321-4321-4321-210987654321'; // Failure Prob
        const SENSOR_CHAR_UUID = 'abcdef01-1234-5678-90ab-cdef01234567'; // Live Sensors

        // --- 2. CHART SETUP ---
        const ctx = document.getElementById('mainChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(20).fill(''),
                datasets: [
                    { label: 'RPM', data: Array(20).fill(0), borderColor: '#22d3ee', tension: 0.4 },
                    { label: 'Temp', data: Array(20).fill(0), borderColor: '#fb923c', tension: 0.4 },
                    { label: 'Load', data: Array(20).fill(0), borderColor: '#c084fc', tension: 0.4 }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { grid: { color: '#334155' }, suggestMin: 0, suggestMax: 100 }
                },
                animation: false
            }
        });

        // --- 3. STATE ---
        let device, server, failChar, sensorChar;
        let isConnected = false;

        function log(msg) {
            const el = document.getElementById('console-log');
            const time = new Date().toLocaleTimeString();
            el.innerHTML += `<div><span class="text-slate-600">[${time}]</span> ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        // --- 4. BLUETOOTH LOGIC ---
        async function connectBLE() {
            try {
                log('Scanning for FEDXAI_DONGLE...');
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID]
                });

                log(`Connecting to ${device.name}...`);
                setConnectionStatus('Connecting...', 'bg-yellow-500');

                server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);

                log('Service found. Getting characteristics...');
                failChar = await service.getCharacteristic(FAIL_CHAR_UUID);
                sensorChar = await service.getCharacteristic(SENSOR_CHAR_UUID);

                // Start Notifications
                await failChar.startNotifications();
                failChar.addEventListener('characteristicvaluechanged', handleFailData);

                await sensorChar.startNotifications();
                sensorChar.addEventListener('characteristicvaluechanged', handleSensorData);

                isConnected = true;
                setConnectionStatus('Connected', 'bg-green-500');
                log('Connected! Streaming data...');

            } catch (error) {
                log(`Error: ${error}`);
                setConnectionStatus('Failed', 'bg-red-500');
            }
        }

        function setConnectionStatus(text, colorClass) {
            document.getElementById('status-text').innerText = text;
            document.getElementById('status-dot').className = `status-dot ${colorClass}`;
            if (text === 'Connected') {
                document.getElementById('connection-status').classList.add('border-green-500/50');
            }
        }

        // --- 5. DATA HANDLERS ---
        function handleFailData(event) {
            const val = event.target.value.getFloat32(0, true); // Little-endian
            const prob = (val * 100).toFixed(1);

            document.getElementById('fail-prob').innerText = `${prob}%`;
            document.getElementById('fail-bar').style.width = `${prob}%`;
            document.getElementById('health-score').innerText = `${(100 - prob).toFixed(0)}%`;

            // Alert Logic
            const alertBox = document.getElementById('alert-box');
            const healthStatus = document.getElementById('health-status');
            const healthBg = document.getElementById('health-bg');

            if (val > 0.5) {
                // FAILURE MODE
                alertBox.className = "glass p-4 rounded-xl border-l-4 border-red-500 bg-red-900/20";
                document.getElementById('xai-msg').innerHTML =
                    `<span class="text-red-400 font-bold">CRITICAL ALERT:</span> Check Fuel Filter & Pump. High Pressure Drop detected.`;

                healthStatus.className = "text-sm text-red-200 font-medium px-3 py-1 bg-red-900/60 rounded-full inline-block relative z-10";
                healthStatus.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-1"></i> FAILURE IMMINENT`;
                healthBg.className = "absolute inset-0 bg-red-500/10 animate-pulse";
            } else {
                // HEALTHY MODE
                alertBox.className = "glass p-4 rounded-xl border-l-4 border-green-500";
                document.getElementById('xai-msg').innerText = "System operating within normal parameters.";

                healthStatus.className = "text-sm text-green-200 font-medium px-3 py-1 bg-green-900/40 rounded-full inline-block relative z-10";
                healthStatus.innerHTML = `<i class="fa-solid fa-check-circle mr-1"></i> HEALTHY`;
                healthBg.className = "absolute inset-0 bg-green-500/10";
            }
        }

        function handleSensorData(event) {
            // Simulated parsing (assuming standard struct packing)
            // ESP32 sends: float rpm, float temp, float load (12 bytes)
            const rpm = event.target.value.getFloat32(0, true);
            const temp = event.target.value.getFloat32(4, true);
            const load = event.target.value.getFloat32(8, true);

            // Update UI
            document.getElementById('val-rpm').innerText = rpm.toFixed(0);
            document.getElementById('val-temp').innerText = temp.toFixed(1) + '°';
            document.getElementById('val-load').innerText = load.toFixed(1) + '%';

            // Push to Chart
            chart.data.datasets[0].data.push(rpm / 80); // Scale RPM (8000 max -> 100)
            chart.data.datasets[1].data.push(temp);     // Temp is usually 0-120
            chart.data.datasets[2].data.push(load);     // Load is 0-100

            chart.data.datasets.forEach(ds => ds.data.shift());
            chart.update('none'); // Perf opt
        }

        // --- SIMULATION MODE (Testing without Dongle) ---
        // Uncomment to test UI without hardware
        /*
        setInterval(() => {
            const rpm = 2000 + Math.random() * 500;
            const temp = 85 + Math.random() * 5;
            const load = 40 + Math.random() * 10;
            const prob = Math.random() > 0.8 ? 0.9 : 0.05; // Random spikes

            handleSensorData({ target: { value: { getFloat32: (o) => [rpm, temp, load][o/4] } } });
            handleFailData({ target: { value: { getFloat32: () => prob } } });
        }, 1000);
        */
    </script>
</body>

</html>